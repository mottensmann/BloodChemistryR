---
title: "R-code for 'TITLE OF THE PAPER'"
author: "AUTHORS OF THE PAPER"
output: html_document
header-includes:
- \usepackage{pdflscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


*In preparation*

This document provides all the `R code` used in our paper. Both the Rmarkdown file and the data can be downloaded from the accompanying GitHub repository on (https://github.com/mottensmann/...) as a zip archive containing all the files. We recommend to download or clone this [GitHub repository](https://github.com/mottensmann/...) in order to access the documentation together with all the files that are needed to repeat analyses shown in this document. Just click on the link above and then on the green box `Clone or download`. In order to function properly, the same structure of folders must be kept. If you have any questions, don't hesitate to contact meinolf.ottensmann[at]web.de

In order to repeat analyses presented in this manuscript a number of packages that extend the functionalities of base `R` are required. These can be installed using the code shown below.

```{r install, comment="install packages", eval=FALSE}
install.packages("ade4")
install.packages("chron")
install.packages("cowplot")
install.packages("factoextra")
install.packages("FactoMineR")
install.packages("EnvStats")
install.packages("ggcorrplot")
install.packages("ggrepel")
install.packages("ggsci")
install.packages("magrittr")
install.packages("MASS")
install.packages("patchwork")
install.packages("RColorBrewer")
install.packages("readxl")
install.packages("reshape2")
install.packages("RVAideMemoire")
install.packages("tidyverse")
install.packages("vegan")
```

Afterwards, make these packages available with the `library` function

```{r, comment="Load packages", message=FALSE, warning=FALSE}
rm(list = ls())
library(ade4)
library(chron)
library(corrplot)
library(cowplot)
library(factoextra)
library(FactoMineR)
library(EnvStats)
library(ggcorrplot)
library(ggrepel)
library(ggsci)
library(magrittr)
library(MASS)
library(patchwork)
library(RColorBrewer)
library(readxl)
library(reshape2)
library(RVAideMemoire)
library(tidyverse)
library(vegan)
```

### Raw data

Raw are available in one single file that is read into the working memory below

```{r read table, message=FALSE, warning=FALSE}
## read data
data <- readxl::read_xlsx("data/raw.xlsx") %>% as.data.frame()
```

For the analysis a few manipulations have to be applied first, including standardising predictor variables using mean-centering. 


```{r}
## coding infection as binomial variable
data$Infection_binomial <- 
  ifelse(data$Infection_intensity == 0, 0, 1) %>% 
  as.factor()
## mean-centering
data$Age <- scale(data$Age_standardised)
## Group infection intensity in three groups
data$Infection_class <- sapply(data$Infection_intensity, function(x) {
    case_when(
  x == 0 ~ "Uninfected",
  x %in% 1:2 ~ "Infected (low)",
  x %in% 3:4 ~ "Infected (high)",
  TRUE ~ as.character(x))
  }) 
```

### Analyses

#### A.) PCA

Principal component analysis as unsupervised clustering approach

```{r}
## Subset the raw data for PCA
pca.dat <- 
  data[,
       c("Leukocyte_count", "Lymphocytes_percent", "Monocytes_percent", "Heterophiles_percent",
         "H_L_ratio", "Basophiles_percent", "Eosinophiles_percent", "AP", "AST",
         "gGT", "CHE", "GLDH", "BA", "LDH", "CK", "ALB",  "TP")] %>% 
  ## mean centering of variables
  scale() %>% 
  na.omit()
```

Visualising correaltion matrix to check for collinear variables

```{r}
## obtain all pairwise correlations 
cor.values <- cor(pca.dat)

## compute p.values using a custom function
# source: http://www.sthda.com/english/wiki/visualize-correlation-matrix-using-correlogram
cor.mtest <- function(mat, ...) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat <- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
        for (j in (i + 1):n) {
            tmp <- cor.test(mat[, i], mat[, j], ...)
            p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
        }
    }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}

# matrix of the p-value of the correlation
p.mat <- cor.mtest(pca.dat)

## Some collinearity is there!
corrplot(cor(pca.dat), type = "upper", order = "hclust", p.mat = p.mat, sig.level = 0.05, tl.srt = 45)
```

The above plot showes that there are a few issues regarding colliniear variables. Most evident is this for the ratio between Heterocytes and Lymphocytes, which is therefore not considered in the subsequent PCA

Running PCA

```{r}
## removing H:L ratio
pca.dat <- subset(pca.dat, select = -c(H_L_ratio))

## Defining function for circular plots
circleFun <- function(center = c(0,0), diameter = 1, npoints = 100){
  r = diameter / 2
  tt <- seq(0,2*pi,length.out = npoints)
  xx <- center[1] + r * cos(tt)
  yy <- center[2] + r * sin(tt)
  return(data.frame(x = xx, y = yy))
}

circ <- circleFun(c(0,0), 2 , npoints = 500)

## Conduct PCA
## PCA  (cf https://tem11010.github.io/Plotting-PCAs/)
pca <- PCA(pca.dat)
## Extract PCÂ´s and reformat
pca.coords <- data.frame(pc1 = unlist(pca$ind$coord[, 1], recursive = T,use.names = T), 
                         pc2 = unlist(pca$ind$coord[, 2], recursive = T,use.names = T))

pca.vars <- pca$var$coord %>% data.frame
pca.vars$vars <- rownames(pca.vars)
pca.vars.m <- melt(pca.vars, id.vars = "vars")

## Plot PCA variables correlation
vars.p <- ggplot() +
  geom_path(data = circ,aes(x, y), lty = 2, color = "grey", alpha = 0.7) +
  geom_hline(yintercept = 0, lty = 2, color = "grey", alpha = 0.9) +
  geom_vline(xintercept = 0, lty = 2, color = "grey", alpha = 0.9) +
  geom_segment(data = pca.vars, aes(x = 0, xend = Dim.1, y = 0, yend = Dim.2),
               arrow = arrow(length = unit(0.025, "npc"), type = "open"), 
               lwd = 1) + 
  geom_text_repel(data = pca.vars, 
                  aes(x = Dim.1*1.15, y =  Dim.2*1.15, 
                      label = colnames(pca.dat), 
                      size = 5)) +
  xlab("PC 1") + 
  ylab("PC 2") +
  coord_equal() +
  theme_minimal() +
  theme(panel.grid = element_blank(), 
        panel.border = element_rect(fill = "transparent"))

## Plot PCA individual with species labels
pca.indplot <- 
  ggplot(data = pca.coords, aes(x = pc1, y = pc2, color = data$Species)) +
  geom_point(size = 4) +
  ## avoid hard coding here!
  labs(x = "PC1 (16.89%)", y = "PC2 (14.98%)") +
  geom_hline(yintercept = 0, lty = 2) +
  geom_vline(xintercept = 0, lty = 2) +
  scale_color_manual(values = c("#427EF6", "#7C3918", "#FF9100")) +
  scale_fill_manual(values = c("#427EF6", "#7C3918", "#FF9100")) +
  theme_classic() +
  theme(legend.position = "bottom", 
        legend.text = element_text(size = 12),
        legend.title = element_blank(),
        axis.title = element_text(size = 14), 
        axis.text = element_text(size = 12), 
        plot.title = element_text(hjust = 0.5, face = "bold"),
        panel.border = element_rect(fill = "transparent")) +
  stat_ellipse(geom = "polygon",
               aes(fill = data$Species),alpha = 0.2, show.legend = F, level = 0.95)


# Plot PCA individuals with infection intensity labels 
pca.infplot <- 
  ggplot(data = pca.coords, aes(x = pc1, y = pc2, color = data$Infection_class)) +
  geom_point(size = 4) +
  ## avpid hard coding !
  labs(x = "PC1 (16.89%)", y = "PC2 (14.98%)") +
  geom_hline(yintercept = 0, lty = 2) +
  geom_vline(xintercept = 0, lty = 2) +
  scale_color_manual(values = c("#A50F15","#FB6A4A","#FCAE91")) +
  scale_fill_manual(values = c("#A50F15","#FB6A4A","#FCAE91")) +
  theme_classic() +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        plot.title = element_text(hjust = 0.5, face = "bold"),
        panel.border = element_rect(fill = "transparent")) +
  stat_ellipse(geom = "polygon",
               aes(fill = data$Infection_class), alpha = 0.2, show.legend = F, level = 0.95)

pca.indplot / pca.infplot | vars.p + plot_layout(ncol = 1)
```


#### B.) LDA

Linear discriminant analysis as supervised clustering method

```{r}
## LDA constrained by Species
qqPlot(pca.dat[,1])
anova(betadisper(dist(pca.dat), data$Species))
ldaSpecies = lda(pca.dat, data$Species)   #  CV=T ajout script Olivier
#MVA.cv(pca.dat, data$Species, model = "LDA")
```

```{r}
par(mfrow = c(1,2))
MVA.plot(ldaSpecies, fac = data$Species, xlab = "LD 1", ylab = "LD 2",
         col = c("#427EF6", "#7C3918", "#FF9100"), legend = F, legend.cex = 0.5,
         legend.pos = "topleft", 
         legend.lab = c("Accipiter gentilis", "Buteo buteo","Milvus milvus"))
MVA.plot(ldaSpecies, "corr", xlab = "Axis 1", ylab = "Axis 2")
```

```{r}
anova(betadisper(dist(pca.dat), data$Infection_class))
ldaInfclass = lda(pca.dat, data$Infection_class)   #  CV=T ajout script Olivier

par(mfrow = c(1,2))
MVA.plot(ldaInfclass, fac = data$Infection_class, 
         xlab = "LD 1", ylab = "LD 2", col = c("#427EF6", "#7C3918", "#FF9100"),
         legend = F)
MVA.plot(ldaInfclass, "corr", xlab = "LD 1", ylab = "LD 2")

# mod=lm(as.matrix(bvPGR)~catptPGR)
# 
# plotresid(mod)
# 
# Manova(mod, test.statistic="Wilks")
# 
# summary(mod)
```

#### C.) Linear models 

##### Test 1: *Heterophiles are significantly higher in infected individuals across species*

```{r}
heterophiles_plot <- ggplot(data, aes(x = as.factor(Infection_binomial), y = Heterophiles_percent)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  theme_classic() +
  theme(text = element_text(size = 12),
        panel.border = element_blank(),
        #strip.background = element_rect(fill = "white", colour = "white"),
        #strip.text = element_text(colour = 'white'),
        plot.margin = grid::unit(c(2,2,2,2), 'mm')) +
  ylab("Heterophiles [%]") +
  xlab("Leucocytozoon infection") +
  stat_n_text() +
  facet_wrap(~Species) 
heterophiles_plot
```


```{r}
lm(Heterophiles_percent ~ Infection_binomial + Sex + Age + Species, data) %>% 
summary()
```

##### Test 2: *Lymphocytes are significantly lower in infected individuals across species*

```{r}
lymphocytes_plot <- ggplot(data,
                            aes(x = as.factor(Infection_binomial), y = Lymphocytes_percent)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  theme_classic() +
  theme(text = element_text(size = 12),
        panel.border = element_blank(),
        #strip.background = element_rect(fill = "white", colour = "white"),
        #strip.text = element_text(colour = 'white'),
        plot.margin = grid::unit(c(2,2,2,2), 'mm')) +
  ylab("Lymphocytes [%]") +
  xlab("Leucocytozoon infection") +
  stat_n_text() +
  facet_wrap(~Species) 
lymphocytes_plot

# with(data, plot(Age, Heterophiles_percent)) marginal reduction with age
```


```{r}
lm(Lymphocytes_percent ~ Infection_binomial + Sex + Age + Species, data) %>% 
summary()
```

##### Test 3: *BA is significantly higher in infected individuals across species*

```{r}
BA_plot <- ggplot(data, aes(x = as.factor(Infection_binomial), y = BA)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  theme_classic() +
  theme(text = element_text(size = 12),
        panel.border = element_blank(),
        #strip.background = element_rect(fill = "white", colour = "white"),
        #strip.text = element_text(colour = 'white'),
        plot.margin = grid::unit(c(2,2,2,2), 'mm')) +
  ylab("BA [%]") +
  xlab("Leucocytozoon infection") +
  stat_n_text() +
  facet_wrap(~Species) 
BA_plot

# with(data, plot(Age, Heterophiles_percent)) marginal reduction with age
```


```{r}
lm(BA ~ Infection_binomial + Sex + Age + Species, data) %>% 
summary()
```

##### Test 4: *AST is significantly higher in infected individuals across species*

```{r}
AST_plot <- ggplot(data, aes(x = as.factor(Infection_binomial), y = AST)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  theme_classic() +
  theme(text = element_text(size = 12),
        panel.border = element_blank(),
        #strip.background = element_rect(fill = "white", colour = "white"),
        #strip.text = element_text(colour = 'white'),
        plot.margin = grid::unit(c(2,2,2,2), 'mm')) +
  ylab("AST [%]") +
  xlab("Leucocytozoon infection") +
  stat_n_text() +
  facet_wrap(~Species) 
AST_plot

# with(data, plot(Age, Heterophiles_percent)) marginal reduction with age
```


```{r}
lm(AST ~ Infection_binomial + Sex + Age + Species, data) %>% 
summary()
```

##### Test 5: *LDH is significantly higher in infected individuals across species*

```{r}
LDH_plot <- ggplot(data, aes(x = as.factor(Infection_binomial), y = LDH)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  theme_classic() +
  theme(text = element_text(size = 12),
        panel.border = element_blank(),
        #strip.background = element_rect(fill = "white", colour = "white"),
        #strip.text = element_text(colour = 'white'),
        plot.margin = grid::unit(c(2,2,2,2), 'mm')) +
  ylab("LDH [%]") +
  xlab("Leucocytozoon infection") +
  stat_n_text() +
  facet_wrap(~Species) 
LDH_plot
```

```{r}
lm(LDH ~ Infection_binomial + Sex + Age + Species, data) %>% 
summary()
```

##### Test 6: *Eosinophiles is significantly higher in infected individuals across species*

```{r}
Eosinophiles_plot <- ggplot(data, aes(x = as.factor(Infection_binomial), y = Eosinophiles_percent)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  theme_classic() +
  theme(text = element_text(size = 12),
        panel.border = element_blank(),
        #strip.background = element_rect(fill = "white", colour = "white"),
        #strip.text = element_text(colour = 'white'),
        plot.margin = grid::unit(c(2,2,2,2), 'mm')) +
  ylab("Eosinophiles [%]") +
  xlab("Leucocytozoon infection") +
  stat_n_text() +
  facet_wrap(~Species) 
Eosinophiles_plot
```

```{r}
lm(Eosinophiles_percent ~ Infection_binomial + Sex + Age + Species, data) %>% 
summary()
```

##### Test 7: *Monocytes do not differ between infeceted and uninfected individuals*

*Monocytes are invariant in buteo buteo*

```{r}
Monocytes_plot <- ggplot(data, aes(x = as.factor(Infection_binomial), y = Monocytes_percent)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  theme_classic() +
  theme(text = element_text(size = 12),
        panel.border = element_blank(),
        #strip.background = element_rect(fill = "white", colour = "white"),
        #strip.text = element_text(colour = 'white'),
        plot.margin = grid::unit(c(2,2,2,2), 'mm')) +
  ylab("Monocytes [%]") +
  xlab("Leucocytozoon infection") +
  stat_n_text() +
  facet_wrap(~Species) 
Monocytes_plot
```

```{r}
lm(Monocytes_percent ~ Infection_binomial + Sex + Age + Species, data) %>% 
summary()
```

##### Test 8: *Basophiles do not differ between infeceted and uninfected individuals*

```{r}
Basophiles_plot <- ggplot(data, aes(x = as.factor(Infection_binomial), y = Basophiles_percent)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  theme_classic() +
  theme(text = element_text(size = 12),
        panel.border = element_blank(),
        #strip.background = element_rect(fill = "white", colour = "white"),
        #strip.text = element_text(colour = 'white'),
        plot.margin = grid::unit(c(2,2,2,2), 'mm')) +
  ylab("Basophiles [%]") +
  xlab("Leucocytozoon infection") +
  stat_n_text() +
  facet_wrap(~Species) 
Basophiles_plot
```

```{r}
lm(Basophiles_percent ~ Infection_binomial + Sex + Age + Species, data) %>% 
summary()
```


##### Test 9: *AP do not differ between infeceted and uninfected individuals*

```{r}
AP_plot <- ggplot(data, aes(x = as.factor(Infection_binomial), y = AP)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  theme_classic() +
  theme(text = element_text(size = 12),
        panel.border = element_blank(),
        #strip.background = element_rect(fill = "white", colour = "white"),
        #strip.text = element_text(colour = 'white'),
        plot.margin = grid::unit(c(2,2,2,2), 'mm')) +
  ylab("AP") +
  xlab("Leucocytozoon infection") +
  stat_n_text() +
  facet_wrap(~Species) 
AP_plot
```

```{r}
lm(AP ~ Infection_binomial + Sex + Age + Species, data) %>% 
summary()
```


##### Test 10: *gGT do not differ between infeceted and uninfected individuals*

```{r}
gGT_plot <- ggplot(data, aes(x = as.factor(Infection_binomial), y = gGT)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  theme_classic() +
  theme(text = element_text(size = 12),
        panel.border = element_blank(),
        #strip.background = element_rect(fill = "white", colour = "white"),
        #strip.text = element_text(colour = 'white'),
        plot.margin = grid::unit(c(2,2,2,2), 'mm')) +
  ylab("gGT") +
  xlab("Leucocytozoon infection") +
  stat_n_text() +
  facet_wrap(~Species) 
gGT_plot
```

```{r}
lm(gGT ~ Infection_binomial + Sex + Age + Species, data) %>% 
summary()
```


##### Test 11: *CHE do not differ between infeceted and uninfected individuals*

```{r}
CHE_plot <- ggplot(data, aes(x = as.factor(Infection_binomial), y = CHE)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  theme_classic() +
  theme(text = element_text(size = 12),
        panel.border = element_blank(),
        #strip.background = element_rect(fill = "white", colour = "white"),
        #strip.text = element_text(colour = 'white'),
        plot.margin = grid::unit(c(2,2,2,2), 'mm')) +
  ylab("CHE") +
  xlab("Leucocytozoon infection") +
  stat_n_text() +
  facet_wrap(~Species) 
CHE_plot
```

```{r}
lm(CHE ~ Infection_binomial + Sex + Age + Species, data) %>% 
summary()
```


##### Test 12: *GLDH do not differ between infeceted and uninfected individuals*

```{r}
GLDH_plot <- ggplot(data, aes(x = as.factor(Infection_binomial), y = GLDH)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  theme_classic() +
  theme(text = element_text(size = 12),
        panel.border = element_blank(),
        #strip.background = element_rect(fill = "white", colour = "white"),
        #strip.text = element_text(colour = 'white'),
        plot.margin = grid::unit(c(2,2,2,2), 'mm')) +
  ylab("GLDH") +
  xlab("Leucocytozoon infection") +
  stat_n_text() +
  facet_wrap(~Species) 
GLDH_plot
```

```{r}
lm(GLDH ~ Infection_binomial + Sex + Age + Species, data) %>% 
summary()
```


##### Test 13: *CK do not differ between infeceted and uninfected individuals*

```{r}
CK_plot <- ggplot(data, aes(x = as.factor(Infection_binomial), y = CK)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  theme_classic() +
  theme(text = element_text(size = 12),
        panel.border = element_blank(),
        #strip.background = element_rect(fill = "white", colour = "white"),
        #strip.text = element_text(colour = 'white'),
        plot.margin = grid::unit(c(2,2,2,2), 'mm')) +
  ylab("GLDH") +
  xlab("Leucocytozoon infection") +
  stat_n_text() +
  facet_wrap(~Species) 
CK_plot
```

```{r}
lm(CK ~ Infection_binomial + Sex + Age + Species, data) %>% 
summary()
```


##### Test 14: *ALB do not differ between infeceted and uninfected individuals*

```{r}
ALB_plot <- ggplot(data, aes(x = as.factor(Infection_binomial), y = ALB)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  theme_classic() +
  theme(text = element_text(size = 12),
        panel.border = element_blank(),
        #strip.background = element_rect(fill = "white", colour = "white"),
        #strip.text = element_text(colour = 'white'),
        plot.margin = grid::unit(c(2,2,2,2), 'mm')) +
  ylab("ALB") +
  xlab("Leucocytozoon infection") +
  stat_n_text() +
  facet_wrap(~Species) 
ALB_plot
```

```{r}
lm(ALB ~ Infection_binomial + Sex + Age + Species, data) %>% 
summary()
```


##### Test 15: *TP do not differ between infeceted and uninfected individuals*

```{r}
TP_plot <- ggplot(data, aes(x = as.factor(Infection_binomial), y = TP)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  theme_classic() +
  theme(text = element_text(size = 12),
        panel.border = element_blank(),
        #strip.background = element_rect(fill = "white", colour = "white"),
        #strip.text = element_text(colour = 'white'),
        plot.margin = grid::unit(c(2,2,2,2), 'mm')) +
  ylab("TP") +
  xlab("Leucocytozoon infection") +
  stat_n_text() +
  facet_wrap(~Species) 
TP_plot
```

```{r}
lm(TP ~ Infection_binomial + Sex + Age + Species, data) %>% 
summary()
```

##### Test 16: *Ca do not differ between infeceted and uninfected individuals*

```{r}
Ca_plot <- ggplot(data, aes(x = as.factor(Infection_binomial), y = Ca)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  theme_classic() +
  theme(text = element_text(size = 12),
        panel.border = element_blank(),
        #strip.background = element_rect(fill = "white", colour = "white"),
        #strip.text = element_text(colour = 'white'),
        plot.margin = grid::unit(c(2,2,2,2), 'mm')) +
  ylab("Ca") +
  xlab("Leucocytozoon infection") +
  stat_n_text() +
  facet_wrap(~Species) 
Ca_plot
```

```{r}
lm(Ca ~ Infection_binomial + Sex + Age + Species, data) %>% 
summary()
```

##### Test 17: *P do not differ between infeceted and uninfected individuals*

```{r}
P_plot <- ggplot(data, aes(x = as.factor(Infection_binomial), y = P)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.4) +
  theme_classic() +
  theme(text = element_text(size = 12),
        panel.border = element_blank(),
        #strip.background = element_rect(fill = "white", colour = "white"),
        #strip.text = element_text(colour = 'white'),
        plot.margin = grid::unit(c(2,2,2,2), 'mm')) +
  ylab("P") +
  xlab("Leucocytozoon infection") +
  stat_n_text() +
  facet_wrap(~Species) 
P_plot
```

```{r}
lm(P ~ Infection_binomial + Sex + Age + Species, data) %>% 
summary()
```